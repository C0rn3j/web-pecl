<?response_header("Package search")?>

<h1>Package search</h1>

<script type="text/javascript" language="javascript" src="javascript/calendar/browserSniffer.js"></script>
<script type="text/javascript" language="javascript" src="javascript/calendar/dynCalendar.js"></script>
<link rel="stylesheet" href="javascript/calendar/dynCalendar.css" media="screen" type="text/css">

<script type="text/javascript" language="javascript">
<!--

    date_updated_released_on     = false;
    date_updated_released_before = false;
    date_updated_released_since  = false;
    
    released_on_disabled     = false;
    released_before_disabled = false;
    released_since_disabled  = false;

    /**
    * Resets the above variables to false when form is cleared
    */
    function form_reset()
    {
        searchForm = document.forms['search_form'];

        if (<?=(int)isset($numrows)?>) {
            location.href = 'package-search.php';

        } else {
            date_updated_released_on     = false;
            date_updated_released_before = false;
            date_updated_released_since  = false;
    
            /**
            * Re-enable date dropdowns
            */
            searchForm.released_before_year.disabled  = false;
            searchForm.released_before_month.disabled = false;
            searchForm.released_before_day.disabled   = false;
    
            searchForm.released_since_year.disabled  = false;
            searchForm.released_since_month.disabled = false;
            searchForm.released_since_day.disabled   = false;
    
            searchForm.released_on_year.disabled  = false;
            searchForm.released_on_month.disabled = false;
            searchForm.released_on_day.disabled   = false;
    
            released_on_disabled     = false;
            released_before_disabled = false;
            released_since_disabled  = false;

            /**
            * Re-enable search button
            */
            searchForm.submitButton.disabled = false;
            return true;
        }
    }

    /**
    * When changed, the date fields in the forms are updated by this
    */
    function update_date(prefix, input)
    {
        searchForm = document.forms['search_form'];
        if (eval('date_updated_' + prefix)) return true;

        yearElement  = searchForm.elements[prefix + '_year'];
        monthElement = searchForm.elements[prefix + '_month'];
        dayElement   = searchForm.elements[prefix + '_day'];
        today = new Date();

        switch (input) {
            case 'year':
                if (monthElement.value != '' || dayElement.value != '') return true;
                monthElement.value = today.getMonth() + 1;
                dayElement.value = today.getDate();
                break;

            case 'month':
                if (yearElement.value != '' || dayElement.value != '') return true;
                yearElement.value = today.getFullYear();
                dayElement.value  = today.getDate();
                break;

            case 'day':
                if (yearElement.value != '' || monthElement.value != '') return true;
                yearElement.value  = today.getFullYear();
                monthElement.value = today.getMonth() + 1;
                break;
        }

        disableDateOptions(prefix);

        eval('date_updated_' + prefix + ' = true');
        return true;
    }

    /**
    * This function sets the date dropdowns to their
    * search values.
    */
    function setReleaseDropdowns()
    {
        if (<?=(int)$set_released_on?>) {
            setDateFromCalendar_released_on('<?=$_GET['released_on_day']?>', '<?=$_GET['released_on_month']?>', '<?=$_GET['released_on_year']?>');
        } else {
            if (<?=(int)$set_released_before?>) {
                setDateFromCalendar_released_before('<?=$_GET['released_before_day']?>', '<?=$_GET['released_before_month']?>', '<?=$_GET['released_before_year']?>');
            }
    
            if (<?=(int)$set_released_since?>) {
                setDateFromCalendar_released_since('<?=$_GET['released_since_day']?>', '<?=$_GET['released_since_month']?>', '<?=$_GET['released_since_year']?>');
            }
        }
    }

    /**
    * Function to disable date dropdowns when the 
    * others are selected.
    */
    function disableDateOptions(prefix)
    {
        /**
        * Disable appropriate option based on what just changed.
        */
        searchForm = document.forms['search_form'];
        switch (prefix) {
            case 'released_on':
                searchForm.released_before_year.disabled  = true;
                searchForm.released_before_month.disabled = true;
                searchForm.released_before_day.disabled   = true;
                released_before_disabled = true;

                searchForm.released_since_year.disabled  = true;
                searchForm.released_since_month.disabled = true;
                searchForm.released_since_day.disabled   = true;
                released_since_disabled = true;
                break;

            case 'released_before':
            case 'released_since':
                searchForm.released_on_year.disabled  = true;
                searchForm.released_on_month.disabled = true;
                searchForm.released_on_day.disabled   = true;
                released_on_disabled = true;
                break;
        }
    }

    /**
    * Callback functions for the calendar
    */
    function setDateFromCalendar_released_on(date, month, year)
    {
        date_updated_released_on = true;
        return setDateFromCalendar('released_on', date, month, year);
    }

    function setDateFromCalendar_released_before(date, month, year)
    {
        date_updated_released_before = true;
        return setDateFromCalendar('released_before', date, month, year);
    }

    function setDateFromCalendar_released_since(date, month, year)
    {
        date_updated_released_since = true;
        return setDateFromCalendar('released_since', date, month, year);
    }

    function setDateFromCalendar(prefix, date, month, year)
    {
        searchForm = document.forms['search_form'];

        if (eval(prefix + '_disabled') == true) {
            return;
        } else {
            disableDateOptions(prefix);
        }

        yearElement  = searchForm.elements[prefix + '_year'].value = year;
        monthElement = searchForm.elements[prefix + '_month'].value = month;
        dayElement   = searchForm.elements[prefix + '_day'].value = date;
    }

    function validate_form()
    {
        searchForm = document.forms['search_form'];

        onYearElement  = searchForm.elements['released_on_year'];
        onMonthElement = searchForm.elements['released_on_month'];
        onDayElement   = searchForm.elements['released_on_day'];

        beforeYearElement  = searchForm.elements['released_before_year'];
        beforeMonthElement = searchForm.elements['released_before_month'];
        beforeDayElement   = searchForm.elements['released_before_day'];

        sinceYearElement  = searchForm.elements['released_since_year'];
        sinceMonthElement = searchForm.elements['released_since_month'];
        sinceDayElement   = searchForm.elements['released_since_day'];

        released_on_changed     = (onYearElement.value     != '' || onMonthElement.value     != '' || onDayElement.value     != '');
        released_before_changed = (beforeYearElement.value != '' || beforeMonthElement.value != '' || beforeDayElement.value != '');
        released_since_changed  = (sinceYearElement.value  != '' || sinceMonthElement.value  != '' || sinceDayElement.value  != '');

        if (released_on_changed && (released_since_changed || released_before_changed)) {
            alert('Cannot combine Released On and Released Before or Since!');
            return false;
        }
        
        document.forms['search_form'].submitButton.value    = 'Sending request...';
        document.forms['search_form'].submitButton.disabled = true;
    }

// -->
</script>


<!-- This class prints stuff as part of it's constructor. -->
<?$bb = new Borderbox("Search options")?>

<form action="<?=$_SERVER['PHP_SELF']?>" method="get" name="search_form" onsubmit="validate_form()">
<table border="0">
    <tr>
        <td>Package name:</td>
        <td valign="middle">
               <?php $form->displayText("pkg_name", @$_GET['pkg_name']); ?>
        </td>
        <td>
            Match:
            <input type="radio" name="bool" value="AND" id="bool_and" <?=$bool_and_checked?> />
            <label for="bool_and">All words</label>
            <input type="radio" name="bool" value="OR" id="bool_or" <?=$bool_or_checked?> />
            <label for="bool_or">Any word</label>
        </td>
    </tr>

    <tr>
        <td>Maintainer:</td>
        <td colspan="2">
            <input name="pkg_maintainer" type="text" value="<?=$_GET['pkg_maintainer']?>">
            <select onchange="document.forms['search_form'].pkg_maintainer.value = this.options[this.selectedIndex].value; this.selectedIndex = 0">
                <option value="">Select user...</option>
                <?foreach($users as $u):?>
                    <option value="<?=$u['handle']?>"><?=$u['name']?></option>
                <?endforeach?>
            </select>
        </td>
    </tr>

    <tr>
        <td valign="top">Category:</td>
        <td>
            <select name="pkg_category" style="width: 100%">
                <option value=""></option>
                <?foreach($category_rows as $c):?>
                    <option value="<?=$c['id']?>" <?=$c['selected']?>><?=$c['name']?></option>
                <?endforeach?>
            </select>
        </td>
        <td>&nbsp;</td>
    </tr>

    <tr><td colspan="3">&nbsp;</td></tr>

    <tr>
        <td colspan="3"><strong>With a release:</strong></td>
    </tr>

    <tr>
        <td>On:</td>
        <td colspan="2">
            <input type="text" name="released_on_year" value="" size="5" onkeyup="update_date('released_on', 'year')">
            <select name="released_on_month" onchange="update_date('released_on', 'month')">
                <option value=""></option>
                <?foreach($months as $num => $text):?>
                    <option value="<?=$num?>"><?=$text?></option>
                <?endforeach?>
            </select>
            <select name="released_on_day" onchange="update_date('released_on', 'day')">
                <option value=""></option>
                <?foreach(range(1, 31) as $value):?>
                    <option value="<?=$value?>"><?=$value?></option>
                <?endforeach?>
            </select>
            <script language="JavaScript" type="text/javascript">
            <!--
                calendarReleasedOn = new dynCalendar('calendarReleasedOn', 'setDateFromCalendar_released_on', 'gifs/');
            //-->
            </script>
        </td>
    </tr>
    
    <tr>
        <td>Before:</td>
        <td colspan="2">
            <input type="text" name="released_before_year" value="" size="5" onkeyup="update_date('released_before', 'year')">
            <select name="released_before_month" onchange="update_date('released_before', 'month')">
                <option value=""></option>
                <?foreach($months as $num => $text):?>
                    <option value="<?=$num?>"><?=$text?></option>
                <?endforeach?>
            </select>
            <select name="released_before_day" onchange="update_date('released_before', 'day')">
                <option value=""></option>
                <?foreach(range(1, 31) as $value):?>
                    <option value="<?=$value?>"><?=$value?></option>
                <?endforeach?>
            </select>
            <script language="JavaScript" type="text/javascript">
            <!--
                calendarReleasedBefore = new dynCalendar('calendarReleasedBefore', 'setDateFromCalendar_released_before', 'gifs/');
            //-->
            </script>
        </td>
    </tr>
    
    <tr>
        <td>Since:</td>
        <td colspan="2">
            <input type="text" name="released_since_year" value="" size="5" onkeyup="update_date('released_since', 'year')">
            <select name="released_since_month" onchange="update_date('released_since', 'month')">
                <option value=""></option>
                <?foreach($months as $num => $text):?>
                    <option value="<?=$num?>"><?=$text?></option>
                <?endforeach?>
            </select>
            <select name="released_since_day" onchange="update_date('released_since', 'day')">
                <option value=""></option>
                <?foreach(range(1, 31) as $value):?>
                    <option value="<?=$value?>"><?=$value?></option>
                <?endforeach?>
            </select>
            <script language="JavaScript" type="text/javascript">
            <!--
                calendarReleasedSince = new dynCalendar('calendarReleasedSince', 'setDateFromCalendar_released_since', 'gifs/');
            //-->
            </script>
        </td>
    </tr>
    
    
    <tr>
        <td>&nbsp;</td>
        <td colspan="2">
            <input type="reset" value="Clear" onclick="return form_reset()" />
            <input type="submit" name="submitButton" value="Search" />
        </td>
    </tr>
</table>
</form>
<?$bb->end()?>

<script language="JavaScript" type="text/javascript">
<!--
    /**
    * Call function to set dropdowns to their search values
    */
    setReleaseDropdowns();
//-->
</script>

<br /><br />

<?if($numrows):?>
    <?$bb = new Borderbox($title_html)?>
    <?foreach($search_results as $row):?>
        <dt><a href="package-info.php?package=<?=$row['raw_name']?>"><?=$row['name']?></a></dt>
        <dd><?=$row['summary']?></dd>
        <br /><br />
    <?endforeach?>
    <?$bb->end()?>

<?elseif($numrows === 0):?>

    <p>
        <strong>No results found</strong>
    </p>
<?endif?>

<?response_footer()?>